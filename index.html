
<!doctype html>
<html lang="pt-BR" data-theme="auto">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>XVI EAC â€” Hub</title>
<meta name="theme-color" content="#000">
<meta name="color-scheme" content="light dark">
<link rel="icon" href="data:,">

<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<style>
  :root {
    --bg: #fbfbfd; --card:#ffffff; --text:#0f172a; --muted:#6e6e73; --border:#e2e8f0; --link:#0071e3;
    --shadow: 0 1px 1px rgba(0,0,0,.06), 0 10px 24px rgba(0,0,0,.06);
    --radius: 18px; --warn:#ff3b30; --ok:#34c759;
  }
  @media (prefers-color-scheme: dark){
    :root { --bg:#020617; --card:#0b1220; --text:#f5f5f7; --muted:#a1a1a6; --border:#1e293b; --link:#0a84ff; --shadow: 0 1px 1px rgba(255,255,255,.02), 0 10px 24px rgba(0,0,0,.5); }
  }
  html[data-theme="light"] { color-scheme: light; --bg:#fbfbfd; --card:#ffffff; --text:#0f172a; --muted:#6e6e73; --border:#e2e8f0; --link:#0071e3; --shadow: 0 1px 1px rgba(0,0,0,.06), 0 10px 24px rgba(0,0,0,.06); }
  html[data-theme="dark"]  { color-scheme: dark;  --bg:#020617; --card:#0b1220; --text:#f5f5f7; --muted:#a1a1a6; --border:#1e293b; --link:#0a84ff; --shadow: 0 1px 1px rgba(255,255,255,.02), 0 10px 24px rgba(0,0,0,.5); }

  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; font-family:-apple-system,system-ui,"SF Pro Text","SF Pro Display",Segoe UI,Roboto,Helvetica Neue,Arial;
        background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; line-height:1.4 }
  .wrap{max-width:880px; margin:0 auto; padding:32px 20px calc(96px + env(safe-area-inset-bottom))}
  .hero{ border-radius: calc(var(--radius)+6px); padding:clamp(18px,4vw,28px); background:var(--card); border:1px solid var(--border); box-shadow:var(--shadow) }
  .row{display:flex; gap:18px; align-items:center; flex-wrap:wrap}
  .brand{ width:64px; height:64px; border-radius:20px; display:grid; place-items:center; border:1px solid var(--border) }
  h1{ font-size:clamp(28px,4vw,40px); letter-spacing:-.02em; margin:0 }
  .sub{ color:var(--muted); font-size:.95rem; margin-top:4px }
  .tagline{ margin-top:10px; font-weight:600; display:inline-block; padding:8px 12px; border-radius:12px; background:rgba(0,0,0,.04); border:1px solid var(--border) }
  @media (prefers-color-scheme: dark){ .tagline{ background:rgba(255,255,255,.06) } }
  .tagline[contenteditable="true"]{ outline:2px solid var(--link); outline-offset:2px }

  .bar{display:flex; gap:10px; align-items:center; margin-top:16px; flex-wrap:wrap}
  .search{ flex:1 1 260px; display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow) }
  .search input{ border:0; outline:0; background:transparent; color:inherit; flex:1 }
  .chip{ border:1px solid var(--border); background:var(--card); padding:10px 14px; border-radius:999px; cursor:pointer; box-shadow:var(--shadow); font-weight:700; touch-action:manipulation }
  .chip[aria-pressed="true"]{ border-color:var(--link) }

  .links{ margin-top:14px; display:grid; gap:12px }
  .item{ position:relative }
  .tile{ display:flex; align-items:center; gap:14px; padding:18px 20px; border-radius:var(--radius); background:var(--card); border:1px solid var(--border); text-decoration:none; color:inherit; box-shadow:var(--shadow) }
  .tile:hover{ transform:translateY(-2px); border-color:color-mix(in srgb, var(--link) 50%, var(--border)) }
  .tile .handle{ width:24px; height:24px; display:grid; place-items:center; opacity:.34; user-select:none; touch-action:none }
  body.reorder .tile .handle{ cursor:grab; opacity:.6 }
  .icon{ width:22px; height:22px; flex:0 0 22px }
  .txt{ display:flex; flex-direction:column; gap:4px; min-width:0 }
  .lbl{ font-weight:800; letter-spacing:-.01em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .desc{ color:var(--muted); font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .meta{ margin-left:auto; display:flex; align-items:center; gap:6px }
  .iconbar{ display:flex; align-items:center; gap:4px }
  .iconbtn{ appearance:none; border:0; background:transparent; width:42px; height:42px; border-radius:50%; display:grid; place-items:center; cursor:pointer; -webkit-tap-highlight-color:transparent }
  .iconbtn:hover{ background:rgba(0,0,0,.06) }
  html[data-theme="dark"] .iconbtn:hover{ background:rgba(255,255,255,.08) }

  /* Modal base (viewer + editor) */
  .modal{ position:fixed; inset:0; background:rgba(15,23,42,.55); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:90; overscroll-behavior:contain }
  .modal.open{ display:flex }
  .modal .box{ width:min(720px, 94%); max-height: min(88dvh, 720px); overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:18px; animation:pop .18s ease }
  @keyframes pop{ from{ transform:scale(.96); opacity:.0 } to{ transform:scale(1); opacity:1 } }
  .modal h3{ margin:0 0 6px 0; font-size:1.2rem }
  .modal pre{ white-space:pre-wrap; word-wrap:break-word; margin:0; color:var(--text); font-family:inherit; line-height:1.5 }
  .modal .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; position:sticky; top:0; background:var(--card); padding-bottom:6px; z-index:1 }
  .modal .close{ border:0; background:transparent; width:40px; height:40px; border-radius:50%; display:grid; place-items:center; cursor:pointer }
  .modal .close:hover{ background:rgba(0,0,0,.06) }
  html[data-theme="dark"] .modal .close:hover{ background:rgba(255,255,255,.08) }
  .modal .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
  .modal .field input, .modal .field textarea, .modal .field select{ border:1px solid var(--border); background:var(--bg); color:inherit; border-radius:10px; padding:12px 14px; font:inherit }
  .modal .row-end{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px; position:sticky; bottom:0; background:var(--card); padding-top:6px }
  .btn-mini{ border:1px solid var(--border); background:var(--card); border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); font-weight:700; cursor:pointer; touch-action:manipulation }
  .btn-mini.warn{ border-color:var(--warn); color:var(--warn) }

  /* Floating add button */
  .fab{ position:fixed; right:20px; bottom:calc(20px + env(safe-area-inset-bottom)); z-index:70 }
  .fab button{ width:60px; height:60px; border-radius:50%; border:1px solid var(--border); background:var(--card); box-shadow:var(--shadow); font-size:28px; font-weight:700; cursor:pointer }

  .toast{ position:fixed; left:50%; bottom:calc(24px + env(safe-area-inset-bottom)); transform:translateX(-50%); background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px 14px; box-shadow:var(--shadow); display:none; z-index:95 }
  .ok{ color:var(--ok); font-weight:700 }

  /* Prevent background scroll when any modal open */
  body.modal-open{ overflow:hidden; height:100dvh }
  @media (prefers-reduced-motion: reduce){ *{ transition:none !important; animation:none !important } }

  


  


  /* ---------- Mobile: Apple-like cell layout ---------- */
  @media (max-width: 640px){
    .wrap{ padding: 18px 14px calc(84px + env(safe-area-inset-bottom)); }
    .links{ gap: 10px; }

    /* iOS-like list cell with full-width title */
    .tile{
      display: grid;
      grid-template-columns: 36px 1fr auto;
      grid-template-rows: auto auto;
      grid-template-areas:
        "icon title actions"
        "icon desc  actions";
      gap: 8px 12px;
      padding: 14px 14px;
      border-radius: 16px;
    }
    .tile .icon   { grid-area: icon; align-self: start; width:22px; height:22px; }
    .tile .txt    { grid-area: title; min-width: 0; }
    .tile .meta   { grid-area: actions; align-self: start; justify-self: end; }
    .lbl{ font-weight: 700; font-size: 1.02rem; line-height: 1.25; white-space: normal; overflow: visible; text-overflow: clip; }
    .desc{
      grid-area: desc;
      margin-top: 2px;
      white-space: normal;
      color: var(--muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: .92rem;
      line-height: 1.35;
    }
    .iconbtn{ width: 42px; height: 42px; }
    /* Drag handle: show only while reordenar; positioned before icon to preserve left edge */
    .tile .handle{ display: none; }
    body.reorder .tile .handle{
      display: grid;
      place-items: center;
      grid-area: icon;
      margin-left: -6px;
      opacity: .7;
    }
  }


  /* ---- Chips: uniform height (incl. theme icon) ---- */
  .chip{ display:flex; align-items:center; justify-content:center; height:40px; padding:0 14px; gap:8px; }
  .chip .icon{ width:18px; height:18px; display:block; }
  /* Toast clickable look when offering Undo */
  .toast.clickable{ cursor:pointer; text-decoration:underline; }


  /* ---- Prevent iOS focus zoom: ensure >=16px on controls ---- */
  .search input,
  .modal .field input,
  .modal .field textarea,
  .modal .field select,
  input, textarea, select {
    font-size: 16px !important;
  }
  html { -webkit-text-size-adjust: 100%; }


  /* ---- Mobile: compact actions column; no overlap with text ---- */
  @media (max-width: 640px){
    .tile{
      grid-template-columns: 36px 1fr 120px; /* icon | text | actions */
      grid-template-areas:
        "icon title actions"
        "icon desc  actions";
    }
    .tile .meta{ grid-area: actions; align-self: start; justify-self: end; width:120px; }
    .iconbar{ display:flex; gap:6px; flex-wrap:nowrap; }
    .iconbtn{ width:36px; height:36px; }
    .txt{ min-width:0; }
    .lbl{ white-space: normal; }
  }

</style>
</head>
<body>
  <!-- Monochrome SVG symbols -->
  <svg style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="11" height="11" rx="2"></rect><rect x="4" y="4" width="11" height="11" rx="2"></rect>
    </symbol>
    <symbol id="i-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 20h4l11-11a2.8 2.8 0 1 0-4-4L4 16v4z"></path>
    </symbol>
    <symbol id="i-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 6h18M8 6V4h8v2M6 6v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6"></path>
    </symbol>
    <symbol id="i-grip" viewBox="0 0 24 24" fill="currentColor">
      <circle cx="7" cy="8" r="1"></circle><circle cx="7" cy="12" r="1"></circle><circle cx="7" cy="16" r="1"></circle>
      <circle cx="11" cy="8" r="1"></circle><circle cx="11" cy="12" r="1"></circle><circle cx="11" cy="16" r="1"></circle>
    </symbol>
    <symbol id="i-link" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10 13a5 5 0 0 1 0-7l1-1a5 5 0 1 1 7 7l-1 1M14 11a5 5 0 0 1 0 7l-1 1a5 5 0 1 1-7-7l1-1"></path>
    </symbol>
    <symbol id="i-note" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 3h9l4 4v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M15 3v5h5"></path>
    </symbol>
    <symbol id="i-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"></circle>
      <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5L19 19M5 19l-1.5 1.5M20.5 3.5L19 5"></path>
    </symbol>
    <symbol id="i-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </symbol>
  </svg>

  <main class="wrap">
    <section class="hero">
      <div class="row">
        <div class="brand" aria-hidden="true">â›ª</div>
        <div>
          <h1 id="title">XVI EAC</h1>
          <div class="sub">ParÃ³quia Senhor Bom Jesus â€¢ DivinÃ³polis/MG</div>
          <span id="tagline" class="tagline" title="Toque para editar" contenteditable="true">Estou a caminho.</span>
        </div>
      </div>

      <div class="bar">
        <div class="search" role="search">ðŸ”Ž <input id="q" type="search" placeholder="Buscar por tÃ­tulo/notaâ€¦" aria-label="Filtrar itens" inputmode="search"></div>
        <button class="chip" id="chipAll" aria-pressed="true">Todos</button>
        <button class="chip" id="chipLinks" aria-pressed="false">Links</button>
        <button class="chip" id="chipNotes" aria-pressed="false">Notas</button>
        <button class="chip" id="reorderToggle" aria-pressed="false" title="Reordenar (alÃ§a Ã  esquerda)">Reordenar</button>
        <button class="chip" id="themeToggle" aria-label="Alternar tema" title="Alternar tema"><svg class="icon" id="themeIcon"><use href="#i-moon"></use></svg></button>
        <div class="fine" style="margin-left:auto; color:var(--muted)">Atualizado em 2025-08-08 12:21</div>
      </div>

      <div id="list" class="links" aria-live="polite"></div>
    </section>
  </main>

  <!-- Add button -->
  <div class="fab"><button id="addBtn" title="Adicionar">+</button></div>

  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

  <!-- Note Viewer Modal -->
  <div id="noteModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="box">
      <div class="top">
        <h3 id="noteModalTitle">Nota</h3>
        <div style="display:flex; gap:6px; align-items:center">
          <button class="close" id="noteEditBtn" title="Editar"><svg class="icon"><use href="#i-edit"></use></svg></button>
          <button class="close" id="noteDeleteBtn" title="Apagar"><svg class="icon"><use href="#i-trash"></use></svg></button>
          <button class="close" id="noteCloseBtn" title="Fechar">âœ•</button>
        </div>
      </div>
      <pre id="noteModalBody"></pre>
    </div>
  </div>

  <!-- Editor Modal (novo) -->
  <div id="editorModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="box">
      <div class="top">
        <h3 id="editorTitle">Novo item</h3>
        <div style="display:flex; gap:6px; align-items:center">
          <button class="close" id="editorCloseBtn" title="Fechar">âœ•</button>
        </div>
      </div>
      <form id="editorForm">
        <div class="field">
          <label for="eType">Tipo do item</label>
          <select id="eType">
            <option value="link">Link</option>
            <option value="note">Nota</option>
          </select>
        </div>
        <div class="field">
          <label for="eTitle">TÃ­tulo</label>
          <input id="eTitle" placeholder="Ex.: Playlist Spotify" required>
        </div>
        <div class="field" id="eUrlRow">
          <label for="eUrl">URL</label>
          <input id="eUrl" placeholder="https://..." inputmode="url">
        </div>
        <div class="field" id="eNoteRow" style="display:none">
          <label for="eContent">Nota</label>
          <textarea id="eContent" rows="8" placeholder="Texto da notaâ€¦"></textarea>
        </div>
        <div class="row-end">
          <button type="button" class="btn-mini warn" id="eDeleteBtn" style="display:none">Excluir</button>
          <button type="submit" class="btn-mini" id="eSaveBtn">Salvar</button>
        </div>
      </form>
    </div>
  </div>

<script type="module">
  // ===================== Firebase =====================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, setDoc, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCIX7hEmpRZacxbzIxUOzKMuu4l0lXBTQQ",
    authDomain: "xvi-eac.firebaseapp.com",
    projectId: "xvi-eac",
    storageBucket: "xvi-eac.appspot.com",
    messagingSenderId: "340488873046",
    appId: "1:340488873046:web:ddc2c775fe977c4d6487f7"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===================== STATE =====================
  const itemsCol = collection(db, "items");
  const mottoDoc = doc(db, "config", "motto");
  let itemsCache = [];
  let filterType = "all"; // all | link | note
  let queryText = "";
  let reorderEnabled = false;
  let editingId = null;
  let lastFocus = null;

  // ===================== HELPERS =====================
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
  function toast(msg, ok=false){
    const t = $("#toast");
    t.classList.remove("clickable");
    t.onclick = null;
    t.textContent = msg;
    if(ok) t.classList.add("ok"); else t.classList.remove("ok");
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", 1600);
  }
  // Undo toast
  let __undoTimer = null;
  let __lastDeleted = null; // {id, data}
  async function deleteWithUndo(id, data){
    try{
      await deleteDoc(doc(itemsCol, id));
      __lastDeleted = { id, data };
      const t = $("#toast");
      t.classList.add("clickable");
      t.innerHTML = "Item apagado â€” <strong>Desfazer</strong>";
      t.style.display = "block";
      t.onclick = async ()=>{
        if(__undoTimer){ clearTimeout(__undoTimer); __undoTimer = null; }
        t.onclick = null; t.classList.remove("clickable");
        if(__lastDeleted){
          await setDoc(doc(itemsCol, __lastDeleted.id), __lastDeleted.data);
          __lastDeleted = null;
          toast("Item restaurado.", true);
        }
      };
      if(__undoTimer){ clearTimeout(__undoTimer); }
      __undoTimer = setTimeout(()=>{
        t.style.display = "none";
        t.onclick = null; t.classList.remove("clickable");
        __lastDeleted = null;
        __undoTimer = null;
      }, 5000);
    }catch(e){ console.error(e); toast("Erro ao apagar."); }
  }
  const svg = (id, cls="icon") => { const s=document.createElementNS("http://www.w3.org/2000/svg","svg"); s.setAttribute("class",cls); s.setAttribute("viewBox","0 0 24 24"); s.innerHTML=`<use href="#${id}"></use>`; return s; };
  function lockScroll(on){ document.body.classList.toggle('modal-open', !!on); }

  // ===================== THEME =====================
  const themeBtn = $("#themeToggle");
  function applyTheme(){
    const t = localStorage.getItem("theme-eac") || "light";
    document.documentElement.setAttribute("data-theme", t);
    const useEl = document.querySelector("#themeIcon use");
    if(useEl){ useEl.setAttribute("href", t==="light" ? "#i-moon" : "#i-sun"); }
  }
  themeBtn.addEventListener("click", ()=>{
    const t = localStorage.getItem("theme-eac") || "light";
    const next = t === "light" ? "dark" : "light";
    localStorage.setItem("theme-eac", next);
    applyTheme();
  });

  // ===================== RENDER =====================
  const listEl = $("#list");
  function matches(it, q){
    if(!q) return true;
    return [it.title||"", it.note||"", it.url||""].join(" ").toLowerCase().includes(q.toLowerCase());
  }
  function render(){
    document.body.classList.toggle("reorder", reorderEnabled);
    listEl.innerHTML = "";
    const filtered = itemsCache
      .filter(({data}) => (filterType==="all" || data.type===filterType) && matches(data, queryText))
      .sort((a,b)=> (a.data.position ?? 999999) - (b.data.position ?? 999999) || (b.data.createdAt?.seconds ?? 0) - (a.data.createdAt?.seconds ?? 0));

    for(const {id, data} of filtered){
      const container = document.createElement("div"); container.className = "item"; container.dataset.id = id;
      const isLink = data.type==="link" && data.url;
      const tile = document.createElement(isLink ? "a" : "div"); tile.className = "tile";
      if(isLink){ tile.href = data.url; tile.target="_blank"; tile.rel="noopener noreferrer"; }
      const handle = document.createElement("div"); handle.className="handle"; handle.title="Arraste para reordenar"; handle.appendChild(svg("i-grip"));
      const icon = svg(data.type==="note" ? "i-note" : "i-link");
      const txt = document.createElement("div"); txt.className="txt";
      const lbl = document.createElement("div"); lbl.className="lbl"; lbl.textContent = data.title || (data.type==="note" ? "Nota" : "Link"); txt.appendChild(lbl);
      if(data.type==="note" && data.note){ const d=document.createElement("div"); d.className="desc"; d.textContent = data.note; txt.appendChild(d); }
      const meta = document.createElement("div"); meta.className = "meta"; const bar = document.createElement("div"); bar.className = "iconbar";
      if(isLink){ const bCopy=document.createElement("button"); bCopy.className="iconbtn"; bCopy.title="Copiar link"; bCopy.appendChild(svg("i-copy"));
        bCopy.addEventListener("click", async (e)=>{ e.preventDefault(); e.stopPropagation(); try{ await navigator.clipboard.writeText(data.url); toast("Link copiado.", true); }catch{ toast("Falha ao copiar."); } }); bar.appendChild(bCopy); }
      const bEdit=document.createElement("button"); bEdit.className="iconbtn"; bEdit.title="Editar"; bEdit.appendChild(svg("i-edit"));
      bEdit.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); openEditor(id, data); });
      const bDel=document.createElement("button"); bDel.className="iconbtn"; bDel.title="Apagar"; bDel.appendChild(svg("i-trash"));
      bDel.addEventListener("click", async (e)=>{ e.preventDefault(); e.stopPropagation(); if(confirm("Apagar este item?")) await deleteWithUndo(id, data); });
      bar.appendChild(bEdit); bar.appendChild(bDel); meta.appendChild(bar);

      tile.appendChild(handle); tile.appendChild(icon); tile.appendChild(txt); tile.appendChild(meta);
      container.appendChild(tile); listEl.appendChild(container);
      if(data.type==="note"){ tile.style.cursor = "pointer"; tile.addEventListener("click", ()=> openNoteViewer(id, data)); }
    }

    if(window.__sortable) window.__sortable.destroy();
    window.__sortable = new Sortable(listEl, {
      animation: 150, handle: ".handle", draggable: ".item",
      disabled: !reorderEnabled,
      onEnd: updateOrderInFirestore
    });
  }

  // ===================== NOTE VIEWER =====================
  const noteModal = $("#noteModal");
  const noteTitle = $("#noteModalTitle");
  const noteBody  = $("#noteModalBody");
  let noteViewingId = null;
  $("#noteCloseBtn").addEventListener("click", ()=> closeModal(noteModal));
  $("#noteModal").addEventListener("click", (e)=>{ if(e.target.id==="noteModal") closeModal(noteModal); });
  $("#noteEditBtn").addEventListener("click", ()=>{ if(!noteViewingId) return; const it = itemsCache.find(d=>d.id===noteViewingId); if(it) openEditor(it.id, it.data); closeModal(noteModal); });
  $("#noteDeleteBtn").addEventListener("click", async ()=>{ if(!noteViewingId) return; if(confirm("Apagar esta nota?")){ const it = itemsCache.find(d=>d.id===noteViewingId); if(it){ await deleteWithUndo(noteViewingId, it.data); } closeModal(noteModal); } });

  function openNoteViewer(id, data){
    noteViewingId = id; openModal(noteModal);
    noteTitle.textContent = data.title || "Nota";
    noteBody.textContent = data.note || "";
  }

  // ===================== EDITOR MODAL =====================
  const editorModal = $("#editorModal");
  const editorForm = $("#editorForm");
  const eType = $("#eType"), eTitle=$("#eTitle"), eUrl=$("#eUrl"), eContent=$("#eContent");
  const eUrlRow=$("#eUrlRow"), eNoteRow=$("#eNoteRow"), eDeleteBtn=$("#eDeleteBtn"), editorTitle=$("#editorTitle");
  $("#editorCloseBtn").addEventListener("click", ()=> closeModal(editorModal));
  editorModal.addEventListener("click", (e)=>{ if(e.target.id==="editorModal") closeModal(editorModal); });
  eType.addEventListener("change", ()=>{ const t = eType.value; eUrlRow.style.display = (t==="link") ? "" : "none"; eNoteRow.style.display = (t==="note") ? "" : "none"; });

  function openEditor(id, data){
    editingId = id;
    editorTitle.textContent = id ? "Editar item" : "Novo item";
    const t = data?.type || "link";
    eType.value = t; eType.dispatchEvent(new Event("change"));
    eTitle.value = data?.title || "";
    eUrl.value = data?.url || "";
    eContent.value = data?.note || "";
    eDeleteBtn.style.display = id ? "" : "none";
    openModal(editorModal, ()=> eTitle.focus());
    lastFocus = document.activeElement;
  }

  editorForm.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const t = eType.value;
    const payload = { type: t, title: (eTitle.value||"").trim(), url: t==="link" ? (eUrl.value||"").trim() : "", note: t==="note" ? (eContent.value||"").trim() : "" };
    if(!payload.title) return toast("Informe um tÃ­tulo.");
    if(t==="link" && !payload.url) return toast("Informe a URL.");
    try{
      if(editingId){
        await updateDoc(doc(itemsCol, editingId), payload);
      } else {
        const pos = listEl.children.length;
        await addDoc(itemsCol, { ...payload, createdAt: serverTimestamp(), position: pos });
      }
      closeModal(editorModal); toast("Salvo.", true);
    } catch(err){ console.error(err); toast("Erro ao salvar."); }
  });

  eDeleteBtn.addEventListener("click", async ()=>{
    if(editingId && confirm("Apagar este item?")){ const it = itemsCache.find(d=>d.id===editingId); const data = it ? it.data : { type:eType.value, title:eTitle.value, url:eUrl.value, note:eContent.value }; await deleteWithUndo(editingId, data); closeModal(editorModal); }
  });

  // Modal helpers
  function openModal(el, onOpen){ el.classList.add("open"); el.setAttribute("aria-hidden","false"); lockScroll(true); onOpen && onOpen(); }
  function closeModal(el){ el.classList.remove("open"); el.setAttribute("aria-hidden","true"); lockScroll(false); if(lastFocus) try{ lastFocus.focus(); }catch{} }

  // ===================== REORDER =====================
  async function updateOrderInFirestore(){
    try{
      const ids = $$(".item", listEl).map(n=>n.dataset.id);
      const batch = writeBatch(db);
      ids.forEach((id, idx)=> batch.update(doc(itemsCol, id), { position: idx }));
      await batch.commit(); toast("Ordem salva.", true);
    }catch(e){ console.error(e); toast("Erro ao salvar ordem."); }
  }
  $("#reorderToggle").addEventListener("click", ()=>{
    if(queryText || filterType!=="all"){ toast("Para reordenar, limpe a busca e selecione 'Todos'."); return; }
    reorderEnabled = !reorderEnabled; $("#reorderToggle").setAttribute("aria-pressed", reorderEnabled); render();
  });

  // ===================== FILTERS & SEARCH =====================
  $("#q").addEventListener("input", (e)=>{ queryText = e.target.value.trim(); render(); });
  $("#chipAll").addEventListener("click", ()=> setType("all"));
  $("#chipLinks").addEventListener("click", ()=> setType("link"));
  $("#chipNotes").addEventListener("click", ()=> setType("note"));
  function setType(t){ filterType = t; $("#chipAll").setAttribute("aria-pressed", t==="all"); $("#chipLinks").setAttribute("aria-pressed", t==="link"); $("#chipNotes").setAttribute("aria-pressed", t==="note"); render(); }

  // ===================== TAGLINE (MOTTO) =====================
  const taglineEl = $("#tagline");
  taglineEl.addEventListener("blur", async ()=>{ try{ await setDoc(mottoDoc, { text: taglineEl.textContent.trim() }); toast("Frase atualizada.", true); }catch(e){ console.error(e); toast("Erro ao salvar frase."); } });
  taglineEl.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); taglineEl.blur(); } });

  // ===================== LIVE SUBSCRIPTIONS =====================
  onSnapshot(mottoDoc, (snap)=>{ const d=snap.data(); if(d?.text) taglineEl.textContent = d.text; });
  onSnapshot(itemsCol, (snap)=>{ itemsCache = snap.docs.map(d=>({ id:d.id, data:d.data() })); render(); }, (err)=>console.error(err));

  // ===================== INIT =====================
  if(!localStorage.getItem('theme-eac')) localStorage.setItem('theme-eac','light');
  applyTheme(); render();
</script>
</body>
</html>
